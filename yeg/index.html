<!DOCTYPE html>
<html>
    <head>
        <title>YEG News Page</title>
        <meta charset='utf-8' >
        <link rel="stylesheet" type="text/css" href="styles.css" >
    </head>
    <body> 
        <div class="middle">
            <p id="content">Tweet content should load here shortly!</p>
        </div>
        <script src="/socket.io/socket.io.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
        <script>
            var socket = io();

            socket.on('connect', function(data) {
                console.log('connected');
                const config = require('./config');
                const twit = require('twit');

                var app = require('express')();
                var http = require('http').createServer(app);
                var io = require('socket.io')(http);

                app.get('/', function(req, res) {
                    res.sendFile(__dirname + '/index.html');
                    T.get('search/tweets', params, searchedData);
                });

                http.listen(3000, function() {
                    console.log('listening on port 3000');
                })

                var T = new twit(config);

                const params = {
                    q: 'startupedmonton',
                    count: 10
                };

                function searchedData(err, data, resp) {
                    var tweetArray = [];
                    for (let index = 0; index < data.statuses.length; index++) {
                        const tweet = data.statuses[index];
                        let tweetbody = {
                            'text': tweet.text,
                            'userScreenName': tweet.user.screen_name,
                            'userImage': tweet.user.profile_image_url_https,
                            'userDescription': tweet.user.description,
                            'idStr': tweet.id_str,
                        }

                        // try {
                        //     if (tweet.entities.media[0].media_url_https) {
                        //         tweetbody['image'] = tweet.entities.media[0].media_url_https;
                        //     }
                        // } catch(e) { }
                        tweetArray.push(tweetbody);
                    }
                    io.emit('allTweet', tweetArray);
                }
            });
        </script>
        <script>
            var socket = io();
            var tweetArray = {};
            var index = 0;

            socket.on('allTweet', function(tweet) {
                tweetArray = tweet;
                loopArray();
            });

            function loopArray() {
                if (tweetArray.length > index) {
                    var currentTweet = tweetArray[index];
                    index++;

                    let html = "<iframe border=0 frameborder=0 height=550 width=850 src=\"https://twitframe.com/show?url=https%3A%2F%2Ftwitter.com%2F"
                                + currentTweet.userScreenName 
                                + "%2Fstatus%2F" 
                                + currentTweet.idStr 
                                + "\"></iframe>"

                    
                    $('#content').html(html);
                } else {
                    index = 0;
                }
                setTimeout(loopArray, 10000);
            }
        </script>
        
    </body>

</html>